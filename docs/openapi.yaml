openapi: 3.0.3
info:
  title: Medical Scheduling System API
  description: |
    A comprehensive medical scheduling system for hospital nurses to automate recurring test and injection schedules.
    Built with Next.js 15, TypeScript, and Supabase.

    **Recent Updates** (2025-11-10, PR 50):
    - Improved error handling: 404 responses for missing resources (previously 500)
    - Department API now uses .maybeSingle() for proper RESTful error codes
  version: 1.0.1
  contact:
    name: API Support
    email: support@medical-scheduler.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.medical-scheduler.com
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Organizations
    description: Multi-tenant organization management
  - name: Patients
    description: Patient management operations
  - name: Schedules
    description: Medical schedule management
  - name: Admin
    description: Administrative operations (admin role required)
  - name: Health
    description: System health monitoring

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user with email and password
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: staff@hospital.com
                password:
                  type: string
                  minLength: 6
                  example: SecurePass123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  profile:
                    $ref: '#/components/schemas/Profile'
                  session:
                    $ref: '#/components/schemas/Session'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: End user session and invalidate token
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: User registration
      description: Create a new user account
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                  example: newuser@hospital.com
                password:
                  type: string
                  minLength: 6
                  example: SecurePass123!
                name:
                  type: string
                  minLength: 1
                  example: John Doe
                role:
                  type: string
                  enum: [nurse, admin, doctor]
                  default: nurse
                care_type:
                  type: string
                  enum: ['외래', '입원', '낮병원']
                  description: Required for nurse role
                phone:
                  type: string
                  example: '+82-10-1234-5678'
      responses:
        '200':
          description: Account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  session:
                    $ref: '#/components/schemas/Session'
                  message:
                    type: string
                    example: Account created successfully. Please check your email for verification.
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organizations/search:
    post:
      tags:
        - Organizations
      summary: Search organizations
      description: Search for organizations by name (for signup process)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - searchTerm
              properties:
                searchTerm:
                  type: string
                  minLength: 1
                  example: 대동병원
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 10
      responses:
        '200':
          description: Organizations found
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Organization'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organizations/create:
    post:
      tags:
        - Organizations
      summary: Create new organization
      description: |
        Create a new organization and assign authenticated user as first admin.
        User ID and name are derived from the authenticated session, not from request body.
        This prevents privilege escalation attacks.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - organization_name
              properties:
                organization_name:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: 새병원
                  description: Name of the new organization
                user_role:
                  type: string
                  enum: [admin, doctor, nurse]
                  default: admin
                  description: Role for the authenticated user (optional, defaults to admin)
      responses:
        '200':
          description: Organization created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizationId:
                    type: string
                    format: uuid
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Organization name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /join-requests:
    post:
      tags:
        - Organizations
      summary: Create join request
      description: Request to join an existing organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - organizationId
                - email
                - name
                - role
              properties:
                organizationId:
                  type: string
                  format: uuid
                email:
                  type: string
                  format: email
                name:
                  type: string
                  minLength: 1
                role:
                  type: string
                  enum: [admin, doctor, nurse]
      responses:
        '200':
          description: Join request created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                    format: uuid
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Duplicate pending request exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/join-requests:
    get:
      tags:
        - Admin
        - Organizations
      summary: List pending join requests
      description: Get all pending join requests for current user's organization (admin only)
      responses:
        '200':
          description: Join requests retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  requests:
                    type: array
                    items:
                      $ref: '#/components/schemas/JoinRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/join-requests/{id}/approve:
    post:
      tags:
        - Admin
        - Organizations
      summary: Approve join request
      description: Approve a pending join request and add user to organization (admin only)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Join request ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                assignedRole:
                  type: string
                  enum: [admin, doctor, nurse]
                  description: Role to assign (overrides requested role if provided)
      responses:
        '200':
          description: Join request approved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Join request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/join-requests/{id}/reject:
    post:
      tags:
        - Admin
        - Organizations
      summary: Reject join request
      description: Reject a pending join request (admin only)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Join request ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for rejection
      responses:
        '200':
          description: Join request rejected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Join request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/profile:
    get:
      tags:
        - Authentication
      summary: Get current user profile
      description: Retrieve profile information for authenticated user
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  profile:
                    $ref: '#/components/schemas/Profile'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags:
        - Authentication
      summary: Update user profile
      description: Update profile information for authenticated user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                care_type:
                  type: string
                  enum: ['외래', '입원', '낮병원']
                phone:
                  type: string
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  profile:
                    $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patients:
    post:
      tags:
        - Patients
      summary: Create a new patient
      description: Register a new patient in the system. Requires approved user status.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - patientNumber
              properties:
                name:
                  type: string
                  pattern: '^[가-힣a-zA-Z\s]+$'
                  minLength: 1
                  maxLength: 100
                  example: 홍길동
                patientNumber:
                  type: string
                  pattern: '^[A-Z0-9]{1,50}$'
                  minLength: 1
                  maxLength: 50
                  example: P12345
                careType:
                  type: string
                  enum: ['외래', '입원', '낮병원']
                isActive:
                  type: boolean
                  default: true
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Patient created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - User not approved or inactive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - Patient number already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patients/{id}/update:
    put:
      tags:
        - Patients
      summary: Update patient
      description: |
        Update patient information. Access control:
        - Admin: Can update all fields including doctor assignment
        - Nurse: Can update basic fields and care-related fields for patients in their care_type
        - Doctor: Can update basic fields for their assigned patients only
      parameters:
        - $ref: '#/components/parameters/PatientIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  pattern: '^[가-힣a-zA-Z\s]+$'
                  minLength: 1
                  maxLength: 100
                patientNumber:
                  type: string
                  pattern: '^[A-Z0-9]{1,50}$'
                  minLength: 1
                  maxLength: 50
                careType:
                  type: string
                  enum: ['외래', '입원', '낮병원']
                  description: Only updatable by nurse and admin roles
                department:
                  type: string
                  maxLength: 50
                  description: Only updatable by nurse and admin roles
                doctorId:
                  type: string
                  format: uuid
                  nullable: true
                  description: Only updatable by admin role
                isActive:
                  type: boolean
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Patient updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patients/{id}/update-doctor:
    post:
      tags:
        - Patients
      summary: Update patient's doctor
      description: Assign or remove a doctor for a patient. Admin role required.
      parameters:
        - $ref: '#/components/parameters/PatientIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - doctorId
              properties:
                doctorId:
                  type: string
                  format: uuid
                  nullable: true
                  description: Doctor ID to assign, or null to remove assignment
      responses:
        '200':
          description: Doctor assignment updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patients/{id}/delete:
    post:
      tags:
        - Patients
      summary: Delete patient
      description: Soft delete a patient (marks as inactive). Triggers cascade deletion of related schedules via database trigger.
      parameters:
        - $ref: '#/components/parameters/PatientIdParam'
      responses:
        '200':
          description: Patient deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/schedules:
    get:
      tags:
        - Schedules
      summary: List schedules
      description: Retrieve paginated list of schedules with filtering options
      parameters:
        - in: query
          name: patientId
          schema:
            type: string
            format: uuid
          description: Filter by patient ID
        - in: query
          name: itemId
          schema:
            type: string
            format: uuid
          description: Filter by item ID
        - in: query
          name: status
          schema:
            type: string
            enum: [active, paused, completed]
          description: Filter by schedule status
        - in: query
          name: startDate
          schema:
            type: string
            format: date-time
          description: Filter schedules starting from this date
        - in: query
          name: endDate
          schema:
            type: string
            format: date-time
          description: Filter schedules ending before this date
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of items per page
        - in: query
          name: sort
          schema:
            type: string
            default: created_at
          description: Field to sort by
        - in: query
          name: order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
      responses:
        '200':
          description: Schedules retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Schedule'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      totalPages:
                        type: integer
                  message:
                    type: string
                    example: Schedules retrieved successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Schedules
      summary: Create schedule
      description: Create a new schedule for a patient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - patientId
                - itemId
                - intervalType
                - intervalValue
                - startDate
              properties:
                patientId:
                  type: string
                  format: uuid
                itemId:
                  type: string
                  format: uuid
                intervalType:
                  type: string
                  enum: [days, weeks, months]
                intervalValue:
                  type: integer
                  minimum: 1
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                notes:
                  type: string
      responses:
        '200':
          description: Schedule created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Schedule'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Patient or item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/schedules/{id}:
    get:
      tags:
        - Schedules
      summary: Get schedule by ID
      description: Retrieve detailed information about a specific schedule
      parameters:
        - $ref: '#/components/parameters/ScheduleIdParam'
      responses:
        '200':
          description: Schedule retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/ScheduleDetail'
                  message:
                    type: string
        '400':
          description: Invalid schedule ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Schedules
      summary: Update schedule
      description: Update schedule information
      parameters:
        - $ref: '#/components/parameters/ScheduleIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                intervalType:
                  type: string
                  enum: [days, weeks, months]
                intervalValue:
                  type: integer
                  minimum: 1
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                status:
                  type: string
                  enum: [active, paused, completed]
                notes:
                  type: string
      responses:
        '200':
          description: Schedule updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Schedule'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Schedules
      summary: Delete schedule
      description: Soft delete a schedule (marks as completed)
      parameters:
        - $ref: '#/components/parameters/ScheduleIdParam'
      responses:
        '200':
          description: Schedule deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: null
                  message:
                    type: string
        '400':
          description: Invalid schedule ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check system health status including database and auth service
      security: []
      responses:
        '200':
          description: Health check completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [healthy, degraded, unhealthy]
                      timestamp:
                        type: string
                        format: date-time
                      uptime:
                        type: integer
                        description: Uptime in milliseconds
                      checks:
                        type: object
                        properties:
                          database:
                            type: object
                            properties:
                              status:
                                type: string
                                enum: [up, down]
                              responseTime:
                                type: integer
                                description: Response time in milliseconds
                              error:
                                type: string
                          auth:
                            type: object
                            properties:
                              status:
                                type: string
                                enum: [up, down]
                              error:
                                type: string
                          realtime:
                            type: object
                            properties:
                              status:
                                type: string
                                enum: [connected, disconnected, reconnecting]
                              activeChannels:
                                type: integer
                      environment:
                        type: string
                        example: development
                      version:
                        type: string
                        example: 1.0.0
                  message:
                    type: string
        '503':
          description: Service unavailable - system unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/users/update:
    post:
      tags:
        - Admin
      summary: Update user
      description: Update user role and care type. Admin role required.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  format: uuid
                role:
                  type: string
                  enum: [admin, nurse, doctor]
                care_type:
                  type: string
                  enum: ['외래', '입원', '낮병원']
                  nullable: true
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/delete-user:
    post:
      tags:
        - Admin
      summary: Delete user
      description: Permanently delete a user account. Admin role required. Cannot delete own account or last admin.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deleted successfully
                  userId:
                    type: string
                    format: uuid
        '400':
          description: Bad request - Cannot delete own account or last admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin access required or invalid origin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Target user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/activity/stats:
    get:
      tags:
        - Admin
      summary: Get activity statistics
      description: Retrieve system activity statistics. Admin role required.
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalUsers:
                    type: integer
                  activeUsers:
                    type: integer
                  totalPatients:
                    type: integer
                  activePatients:
                    type: integer
                  totalSchedules:
                    type: integer
                  activeSchedules:
                    type: integer
                  recentActivities:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          format: date-time
                        action:
                          type: string
                        user_id:
                          type: string
                          format: uuid
                        details:
                          type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

    options:
      tags:
        - Admin
      summary: CORS preflight
      description: Handle OPTIONS requests for CORS
      security: []
      responses:
        '200':
          description: CORS headers returned

  /admin/activity/logs:
    get:
      tags:
        - Admin
      summary: Get audit logs
      description: Retrieve system audit logs with filtering. Admin role required.
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date
          description: Filter logs from this date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
          description: Filter logs until this date
        - in: query
          name: userId
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - in: query
          name: tableName
          schema:
            type: string
          description: Filter by table name
        - in: query
          name: operation
          schema:
            type: string
            enum: [INSERT, UPDATE, DELETE]
          description: Filter by operation type
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Audit logs retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        table_name:
                          type: string
                        operation:
                          type: string
                        user_id:
                          type: string
                          format: uuid
                        timestamp:
                          type: string
                          format: date-time
                        old_data:
                          type: object
                        new_data:
                          type: object
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      totalPages:
                        type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

    options:
      tags:
        - Admin
      summary: CORS preflight
      description: Handle OPTIONS requests for CORS
      security: []
      responses:
        '200':
          description: CORS headers returned

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login endpoint

  parameters:
    PatientIdParam:
      in: path
      name: id
      required: true
      schema:
        type: string
        format: uuid
      description: Patient unique identifier

    ScheduleIdParam:
      in: path
      name: id
      required: true
      schema:
        type: string
        format: uuid
      description: Schedule unique identifier

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [nurse, admin, doctor]
        care_type:
          type: string
          enum: ['외래', '입원', '낮병원']
          nullable: true
        phone:
          type: string
          nullable: true
        approval_status:
          type: string
          enum: [pending, approved, rejected]
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Session:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          example: 3600
        token_type:
          type: string
          example: bearer

    Patient:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        patient_number:
          type: string
        care_type:
          type: string
          enum: ['외래', '입원', '낮병원']
          nullable: true
        department:
          type: string
          nullable: true
        doctor_id:
          type: string
          format: uuid
          nullable: true
        is_active:
          type: boolean
        metadata:
          type: object
          additionalProperties: true
        created_by:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Schedule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        patient_id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
        interval_type:
          type: string
          enum: [days, weeks, months]
        interval_value:
          type: integer
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [active, paused, completed]
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        patients:
          type: object
          properties:
            name:
              type: string
            patient_number:
              type: string
        items:
          type: object
          properties:
            name:
              type: string
            category:
              type: string

    ScheduleDetail:
      allOf:
        - $ref: '#/components/schemas/Schedule'
        - type: object
          properties:
            events:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  schedule_id:
                    type: string
                    format: uuid
                  event_date:
                    type: string
                    format: date
                  status:
                    type: string
                  executed_by:
                    type: string
                    format: uuid
                    nullable: true
                  executed_at:
                    type: string
                    format: date-time
                    nullable: true
                  notes:
                    type: string
                    nullable: true

    Organization:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        created_at:
          type: string
          format: date-time
        member_count:
          type: integer
          description: Number of members in the organization

    JoinRequest:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [admin, doctor, nurse]
        status:
          type: string
          enum: [pending, approved, rejected]
        reviewed_by:
          type: string
          format: uuid
          nullable: true
        reviewed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          type: object
          description: Additional error details

  responses:
    UnauthorizedError:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            code: AUTH_REQUIRED

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not Found
            code: RESOURCE_NOT_FOUND

    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Bad Request
            code: VALIDATION_ERROR
            details:
              fields:
                - field: email
                  message: Invalid email format

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal server error
            code: INTERNAL_ERROR

    RateLimitExceeded:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Too many requests
            code: RATE_LIMIT_EXCEEDED
            details:
              retryAfter: 60