훌륭한 결정입니다. 한국의 의료법 관련 규정을 반영하여 **1:N (사용자:조직)** 모델을 유지하는 것은 매우 현실적이고 올바른 판단입니다. 주신 피드백을 반영하여, 제안드렸던 나머지 개선 사항들을 통합한 최종 계획서를 작성해 드리겠습니다.

이 최종 계획안은 기존의 훌륭한 구조를 유지하면서, 시니어 관점에서 보완된 내용들을 자연스럽게 통합하여 완성도를 높였습니다.

---

## **Multi-Tenancy 전환 최종 계획서 (Final Draft)**

**💡 상태: 최종 계획 확정 (피드백 반영)**

**작성일**: 2025-09-28
**최종 업데이트**: 2025-11-07 (시니어 피드백 및 최종 의사결정 반영)
**대상 시스템**: 의료 스케줄링 시스템
**목표**: 다기관 지원 시스템 (Multi-Tenancy)으로 전환

---

### **주요 변경 및 확정 사항 (개선안 반영)**

주니어 개발자의 원안이 매우 훌륭하여 구조를 유지하되, 아래와 같이 시니어 개발자의 검토 의견을 반영하여 계획을 최종 확정합니다.

1.  **사용자-조직 관계 모델 유지 (1:N)**
    *   한국 의료법상 의료인은 하나의 의료기관에만 소속될 수 있다는 현업의 특수성을 반영하여, 사용자가 하나의 조직에만 속하는 현재의 1:N 모델(`profiles` 테이블에 `organization_id` 포함)을 유지합니다. 이는 초기 계획의 타당성을 재확인한 것입니다.
2.  **Super Admin 권한 제한 (HIPAA 규정 준수 강화)**
    *   Super Admin이 원칙적으로 환자 의료 정보(PHI)에 접근할 수 없도록 권한을 축소합니다. 시스템 운영 및 기관 관리에만 집중하도록 역할을 재정의하고, 비상시 접근을 위한 'Break-Glass' 절차를 보안 고려사항에 명시합니다.
3.  **초대(Invitation) 기반 온보딩 플로우 추가**
    *   기존의 '기관 코드 입력' 방식과 더불어, 기관 관리자(`org_admin`)가 이메일로 팀원을 초대하는 기능을 추가하여 보안과 사용자 경험을 향상시킵니다. 이를 위해 `invitations` 테이블을 신설합니다.
4.  **자원 격리 및 제어 (Quota, Rate Limiting) 전략 구체화**
    *   조직별 사용자 및 환자 수 제한(Quota)을 API 레벨에서 강제하는 방안을 명시하고, 특정 조직의 과도한 요청이 전체 시스템에 영향을 주지 않도록 Rate Limiting 정책을 도입합니다.
5.  **오프보딩 (조직 비활성화/탈퇴) 정책 추가**
    *   조직이 서비스를 탈퇴할 경우를 대비하여 데이터 처리 정책(논리적 삭제, 보존 기간, 영구 삭제)을 명확히 정의합니다.
6.  **테스트 계획 구체화**
    *   데이터 격리 검증을 위한 구체적인 테스트 시나리오를 추가하여, QA의 완성도를 높입니다.

---

### **목차 (기존 유지)**

1.  [개요](#개요)
2.  [의사결정 사항 (확정)](#의사결정-사항-확정)
3.  [관리자 계층 구조](#관리자-계층-구조)
4.  [데이터베이스 스키마 변경사항](#1-데이터베이스-스키마-변경사항)
5.  [인증 및 권한 관리](#2-인증-및-권한-관리)
6.  [데이터 격리 전략](#3-데이터-격리-전략)
7.  [UI/UX 변경사항](#4-uiux-변경사항)
8.  [API 및 서비스 레이어 변경](#5-api-및-서비스-레이어-변경)
9.  [마이그레이션 전략](#6-마이그레이션-전략)
10. [성능 고려사항](#7-성능-고려사항)
11. [보안 고려사항](#8-보안-고려사항)
12. **[신규]** [오프보딩 및 데이터 처리 정책](#13-오프보딩-및-데이터-처리-정책-신규)
13. [구현 체크리스트](#구현-체크리스트)
14. [잠재적 위험 요소](#10-잠재적-위험-요소)

---

### **관리자 계층 구조 (개선안 반영)**

#### Super Admin 역할 재정의 (HIPAA 준수)

`SUPER_ADMIN`은 플랫폼의 기술적 운영 및 관리를 책임지며, **원칙적으로 환자의 민감한 의료 정보(PHI)에 접근할 수 없습니다.**

```
┌─────────────────────────────────────────────────┐
│         SUPER_ADMIN (플랫폼 관리자)              │
│  - 기관 생성/승인/비활성화/삭제                  │
│  - 구독(Subscription) 및 플랜 관리                │
│  - 기관 관리자(org_admin) 권한 부여/회수          │
│  - 전체 시스템 설정 및 비식별 통계 모니터링       │
│  - 전체 감사 로그 접근 (데이터 내용 제외)         │
│  - ⚠️ 환자 데이터 접근 불가 (예외적 경우 'Break-Glass' 절차 준수) │
└─────────────────────────────────────────────────┘
```

#### 권한 매트릭스 (개선안 반영)

| 기능 | SUPER_ADMIN | ORG_ADMIN | DOCTOR | NURSE |
| :--- | :--- | :--- | :--- | :--- |
| **환자 관리** | ⚠️ | ✅ (기관 전체) | ✅ (자신의 환자) | ✅ (케어 타입별) |
| **스케줄 관리** | ⚠️ | ✅ (기관 전체) | ✅ (자신의 환자) | ✅ (케어 타입별) |
| **감사 로그 조회** | ✅ | ✅ (자신의 기관) | ❌ | ❌ |

**⚠️ (제한적 접근):** Super Admin은 원칙적으로 환자 데이터에 접근할 수 없습니다. 고객 지원 등 긴급 상황 발생 시, 명시적 동의와 엄격한 감사 로깅 하에 일시적으로 접근 권한을 얻는 'Break-Glass' 절차를 통해서만 접근이 허용됩니다. (상세 내용은 [보안 고려사항](#8-보안-고려사항) 참고)

---

### **1. 데이터베이스 스키마 변경사항 (개선안 반영)**

#### 1.1 `organizations` 테이블 생성 (원안 유지)

(원안과 동일)

#### 1.2 기존 테이블에 `organization_id` 추가 (원안 유지 - **확정**)

**확정 사항:** 한국 의료법 규정에 따라 사용자는 하나의 기관에만 소속되므로, `profiles` 테이블에 `organization_id`를 두는 1:N 관계 모델을 최종 확정합니다. Junction 테이블은 도입하지 않습니다.

(원안과 동일)

#### 1.3 `invitations` 테이블 생성 (신규)

```sql
-- Migration: 20251107000001_create_invitations_table.sql
CREATE TABLE IF NOT EXISTS invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role UserRole NOT NULL,
  token TEXT UNIQUE NOT NULL DEFAULT extensions.uuid_generate_v4()::text,
  expires_at TIMESTAMPTZ NOT NULL DEFAULT now() + interval '7 days',
  invited_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(organization_id, email) -- 한 조직에 동일 이메일 초대는 하나만 존재
);

CREATE INDEX idx_invitations_token ON invitations(token);
CREATE INDEX idx_invitations_email ON invitations(email);
```

(이후 RLS 정책, 트리거 등 나머지 DB 계획은 원안을 유지합니다.)

---

### **2. 인증 및 권한 관리 (개선안 반영)**

#### 2.3 회원가입 시나리오 (확장)

**시나리오 3: 초대 기반 참여 (권장)**
1.  `org_admin`이 팀원의 이메일과 역할을 입력하여 초대 링크를 생성 및 발송합니다.
2.  초대받은 사용자는 이메일의 링크를 통해 회원가입 페이지로 이동합니다.
3.  회원가입 완료 시, 별도의 승인 대기 없이 즉시 해당 조직의 'approved' 상태 멤버가 됩니다.

---

### **4. UI/UX 변경사항 (개선안 반영)**

#### 4.1 회원가입 플로우 개선 (원안 유지)
(원안과 동일)

#### 4.4 기관 관리자(Org Admin) 페이지 개선 (신규)
*   **팀원 초대 UI 추가:** `org_admin`이 팀원의 이메일 주소와 역할을 입력하여 초대를 보낼 수 있는 메뉴를 추가합니다. (`/admin/users/invite`)
*   **초대 현황 관리 UI:** 발송한 초대 목록과 수락 여부(`pending`, `accepted`)를 확인할 수 있는 테이블을 추가합니다.

---

### **5. API 및 서비스 레이어 변경 (개선안 반영)**

#### 5.3 API Rate Limiting 및 Quota 적용 (신규)
1.  **미들웨어 수정:**
    *   모든 인증된 API 요청에 대해 `organization_id`를 기준으로 Rate Limiting을 적용합니다. (예: 분당 100회 요청)
    *   이를 통해 'Noisy Neighbor' 문제를 방지합니다.
2.  **자원 생성 API 수정 (`POST /api/patients`, `POST /api/users`)**
    *   API 핸들러 로직 초반에, 요청된 `organization_id`의 현재 자원 수(환자, 사용자)를 조회합니다.
    *   `organizations` 테이블의 `max_patients`, `max_users` 값과 비교하여 한도를 초과할 경우 `403 Forbidden` 에러와 함께 "조직의 최대 환자 수를 초과했습니다." 와 같은 명확한 메시지를 반환합니다.

---

### **8. 보안 고려사항 (개선안 반영)**

#### 8.4 Super Admin의 PHI 접근 통제 ('Break-Glass' 절차) (신규)
Super Admin의 환자 정보 접근은 원칙적으로 금지되며, 다음과 같은 'Break-Glass' 절차를 통해서만 예외적으로 허용됩니다.
1.  **사전 승인:** 데이터 접근이 필요한 경우, 해당 기관(`org_admin`)의 명시적인 서면 동의를 받습니다.
2.  **권한 상승:** 동의를 근거로, 제한된 시간(예: 1시간) 동안 특정 기관의 데이터에 접근할 수 있는 권한을 일시적으로 부여받습니다.
3.  **상세 로깅:** 권한이 상승된 세션 동안 Super Admin이 수행하는 모든 데이터 조회 및 변경 활동은 **가장 상세한 레벨로 감사 로그(Audit Log)에 기록**됩니다.
4.  **자동 만료 및 보고:** 지정된 시간이 지나면 권한은 자동으로 회수되며, 활동 내역은 해당 기관 관리자에게 보고됩니다.

---

### **9. 마이그레이션 전략 (개선안 반영)**

#### Phase 4: 테스팅 (구체화)
데이터 격리 및 권한 테스트를 위해 다음과 같은 구체적인 시나리오를 추가합니다.

*   **주요 테스트 시나리오 예시:**
    1.  **데이터 격리 조회 테스트:**
        *   **준비:** `Org_A`, `Org_B` 조직과 각 조직 소속의 `user_A`, `user_B` 생성. `user_B`가 `patient_B`를 생성.
        *   **실행:** `user_A`의 인증 정보로 `GET /api/patients/{patient_B의 ID}` API를 직접 호출.
        *   **결과:** `404 Not Found` 또는 `403 Forbidden` 응답을 받아야 함. `200 OK`와 함께 `patient_B`의 정보가 반환되면 실패.
    2.  **데이터 격리 생성 테스트:**
        *   **준비:** 위와 동일. 추가로 `Org_A` 소속의 `patient_A` 생성.
        *   **실행:** `user_B`의 인증 정보로, `patient_A`에게 스케줄을 생성하는 `POST /api/schedules` API 호출. (Body에 `patient_id: patient_A_id` 포함)
        *   **결과:** 데이터베이스 트리거(`validate_org_consistency`)에 의해 `EXCEPTION`이 발생하거나, API 레벨에서 `403 Forbidden` 응답을 반환해야 함.
    3.  **Super Admin PHI 접근 차단 테스트:**
        *   **준비:** `Super_Admin` 계정과 `Org_A`의 `patient_A` 생성.
        *   **실행:** `Super_Admin` 계정으로 `GET /api/patients/{patient_A의 ID}` API를 직접 호출.
        *   **결과:** `403 Forbidden` 응답을 받아야 함.

---

### **13. 오프보딩 및 데이터 처리 정책 (신규)**

#### 13.1 조직 비활성화 (논리적 삭제, Soft Deletion)
*   **실행:** `org_admin` 또는 `super_admin`이 조직 비활성화를 요청하면, `organizations` 테이블의 `is_active` 플래그를 `false`로 변경합니다.
*   **효과:**
    *   해당 조직의 모든 사용자는 시스템에 로그인할 수 없게 됩니다.
    *   모든 데이터(환자, 스케줄 등)는 삭제되지 않고 데이터베이스에 보존됩니다.
    *   조직 데이터는 더 이상 API를 통해 조회되지 않습니다.

#### 13.2 데이터 보존 및 영구 삭제
*   **보존 기간:** 비활성화된 조직의 데이터는 법적 규제 및 서비스 정책에 따라 **90일**간 보존됩니다.
*   **영구 삭제:** 보존 기간이 만료된 후, 스케줄된 백그라운드 작업을 통해 해당 `organization_id`와 관련된 모든 데이터가 영구적으로 삭제됩니다. `ON DELETE CASCADE` 제약 조건을 적극 활용합니다.
*   **데이터 내보내기(Export):** `org_admin`은 조직 비활성화 후 30일 이내에 소속된 환자 및 스케줄 데이터를 CSV 형태로 내보낼 수 있는 기능을 제공하는 것을 장기적으로 고려합니다. (초기 MVP에서는 제외)

---
(나머지 개요, 성능, 위험 요소, 구현 체크리스트 등의 섹션은 원안의 내용이 훌륭하여 그대로 유지합니다. 단, 체크리스트에는 `invitations` 테이블 생성 및 관련 UI/API 개발 항목을 추가해야 합니다.)