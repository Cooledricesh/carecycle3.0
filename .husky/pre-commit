#!/bin/bash

echo "üöÄ Pre-commit Hook: Running checks..."
echo "======================================"
echo ""

# Step 1: Check for hardcoded secrets
echo "üîç [1/2] Scanning for hardcoded API keys and secrets..."

PATTERNS=(
  'sb_secret_[a-zA-Z0-9_]+'
  'sb_publishable_[a-zA-Z0-9_]+'
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9'
  'NEXT_PUBLIC_SUPABASE_URL.*=.*https?://[a-z]+\.supabase\.co'
  'SUPABASE_SECRET_KEY.*=.*sb_secret'
  'NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY.*=.*sb_publishable'
)

FILES_TO_CHECK=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES_TO_CHECK" ]; then
  echo "‚úÖ No files to check"
else
  FOUND_SECRETS=0

  for pattern in "${PATTERNS[@]}"; do
    for file in $FILES_TO_CHECK; do
      if [ -f "$file" ]; then
        if grep -qE "$pattern" "$file"; then
          echo "‚ùå BLOCKED: Found potential hardcoded secret in $file"
          echo "   Pattern: $pattern"
          echo ""
          grep -nE "$pattern" "$file" | head -3
          echo ""
          FOUND_SECRETS=1
        fi
      fi
    done
  done

  if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "üö® COMMIT BLOCKED: Hardcoded secrets detected!"
    echo ""
    echo "Please remove all hardcoded API keys and use environment variables instead:"
    echo "  ‚úÖ process.env.NEXT_PUBLIC_SUPABASE_URL"
    echo "  ‚úÖ process.env.SUPABASE_SECRET_KEY"
    echo "  ‚úÖ process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY"
    echo ""
    echo "If this is a false positive, you can skip this check with:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
  fi

  echo "‚úÖ No hardcoded secrets detected"
fi

echo ""

# Step 2: Update OpenAPI specification
echo "üìù [2/2] Updating OpenAPI specification..."
echo ""

# Check if any API route files are being committed
API_ROUTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "src/app/api.*route\.tsx\?$" || true)

if [ -n "$API_ROUTE_FILES" ]; then
  echo "üîÑ API route changes detected:"
  for file in $API_ROUTE_FILES; do
    echo "   ‚Ä¢ $file"
  done
  echo ""
  echo "Running OpenAPI generator..."
  echo ""

  # Run the OpenAPI generation script
  if [ -f "scripts/generate-openapi.sh" ]; then
    bash scripts/generate-openapi.sh
    OPENAPI_RESULT=$?

    if [ $OPENAPI_RESULT -ne 0 ]; then
      echo ""
      echo "‚ùå OpenAPI generation failed"
      echo "   Please check your API route files and try again"
      exit 1
    fi
  else
    echo "‚ö†Ô∏è  OpenAPI generation script not found"
    echo "   Expected: scripts/generate-openapi.sh"
    echo "   Skipping automatic OpenAPI update"
  fi
else
  echo "‚ÑπÔ∏è  No API route changes detected, skipping OpenAPI update"
fi

echo ""
echo "======================================"
echo "‚úÖ All pre-commit checks passed!"
echo "======================================"
exit 0
