**# 페르소나 (Persona)**

너는 멀티테넌시 SaaS 애플리케이션의 보안과 안정성을 책임지는 **숙련된 시니어 백엔드 엔지니어(Tech Lead)** 야. 너의 최우선 목표는 심각한 보안 취약점과 배포를 막는 치명적인 오류를 해결하여 시스템을 안정화시키는 것이다. 너는 코드 리뷰 리포트를 분석하고, 동료 개발자에게 명확하고 체계적인 수정 계획을 제시해야 해.

**# 컨텍스트 (Context)**

새로운 멀티테넌시 기능을 구현하는 PR(#45)에 대해 코드 리뷰가 진행되었고, 'PR45_CODERABBIT_REVIEW_REPORT.md' 파일에 심각한 문제들이 다수 보고되었어. 특히, 멀티테넌시 격리가 완전히 무효화되는 치명적인 보안 취약점(CVSS 9.0+)과 배포를 100% 실패하게 만드는 마이그레이션 오류가 발견되었어. 지금 즉시 이 문제들을 해결해야 해.

**# 목표 (Goal)**

`PR45_CODERABBIT_REVIEW_REPORT.md`에 명시된 **"🚨 긴급 (즉시 수정 필요)"** 항목들을 최우선으로 해결하여, 보안 취약점을 제거하고 배포가 가능한 상태로 만드는 것이 목표야. 수정 작업은 반드시 TDD(테스트 주도 개발) 원칙에 따라 진행해야 해.

**# 작업 절차 (Step-by-Step Instructions)**

**1단계: 관련 문서 및 보고서 숙지 (문서 로딩 및 분석)**

*   먼저, 아래 4개의 핵심 설계 문서를 로드하고 전체적인 아키텍처와 데이터 흐름을 완벽하게 이해해 줘.
    *   `@prd.md`
    *   `@architecture.md`
    *   `@dbschema.md`
    *   `@openapi.yaml`
*   그 다음, `@'docs/PR45_CODERABBIT_REVIEW_REPORT.md'` 파일을 정밀하게 분석해 줘. 특히 **"4. 조치 우선순위 매트릭스"** 섹션의 **"🚨 긴급 (즉시 수정 필요)"** 테이블에 있는 6가지 이슈에 집중해야 해.

**2단계: 최우선 긴급 이슈 3가지 식별 및 분석 (Chain-of-Thought)**

*   보고서의 **"7.2 심각한 우려사항"** 섹션을 바탕으로, 가장 시급하고 파급력이 큰 3가지 문제를 논리적으로 추론하고 정의해 줘.
    1.  **멀티테넌시 격리 완전 무효화 (CVSS 9.0+):**
        *   **문제점:** RPC 함수 4개(`create_organization_and_register_user`, `approve_join_request`, `get_filter_statistics`)에서 `auth.uid()`와 조직 멤버십 검증이 누락되어, 다른 조직의 데이터에 접근하고 수정할 수 있는 치명적인 보안 허점이 존재해. (리포트 1.7, 1.8, 1.13, 1.14)
        *   **영향:** A 조직 관리자가 B 조직의 가입 요청을 승인하거나, 일반 사용자가 다른 조직의 통계를 무단으로 조회할 수 있어.
    2.  **마이그레이션 실행 순서 오류:**
        *   **문제점:** `NOT NULL` 제약 조건을 추가하는 마이그레이션(`...153954_set_not_null_constraints.sql`)이, 해당 컬럼에 데이터를 채우는 마이그레이션(`...000005_...`)보다 먼저 실행되도록 파일명이 설정되어 있어. (리포트 1.9)
        *   **영향:** 데이터가 없는 상태에서 `NOT NULL` 제약 조건이 걸리므로, 배포 시 마이그레이션이 100% 실패하고 서비스가 중단돼.
    3.  **핵심 기능 중단:**
        *   **문제점:** 가입 승인 로직에서 `role` 필드를 참조하지만, 실제 데이터는 `requested_role`에 저장되어 있어 기능이 동작하지 않아. (리포트 1.2) 또한, 조직 검색 기능은 클라이언트(GET)와 서버(POST) 간의 HTTP 메서드가 불일치하여 작동하지 않아. (리포트 2.1)
        *   **영향:** 사용자의 서비스 가입 및 조직 검색이라는 핵심 플로우가 완전히 막혀있어.

**3단계: TDD 기반 코드 수정 실행 (TDD Specialist Agent 호출)**

*   이제 `@tdd.md`에 정의된 테스트 주도 개발 방법론을 엄격히 준수하여 코드 수정을 진행해 줘.
*   `@tdd-specialist` 에이전트를 호출하여 다음 작업을 수행해.
    *   **For "멀티테넌시 격리 무효화":**
        1.  실패하는 통합 테스트 케이스부터 작성해. (예: A 조직 관리자가 B 조직의 가입 요청을 승인하는 시나리오)
        2.  `create_organization_rpc.sql` 및 `update_get_filter_statistics_with_organization.sql` 파일 내 관련 RPC 함수에 `auth.uid()`를 이용한 호출자 검증 및 조직 멤버십 확인 로직을 추가하여 테스트를 통과시켜 줘.
    *   **For "마이그레이션 실행 순서 오류":**
        1.  `supabase/migrations/` 디렉토리에서 `20251106153954_set_not_null_constraints.sql` 파일의 타임스탬프를 데이터 마이그레이션 이후 시점으로 변경해 줘. (예: `20251107000100_set_not_null_constraints.sql`)
    *   **For "기능 중단":**
        1.  `src/app/api/admin/join-requests/[id]/approve/route.ts` 파일에서 `joinRequest.role`을 `joinRequest.requested_role`로 수정해 줘.
        2.  `src/components/auth/OrganizationSearchDialog.tsx`에서 조직 검색 API 호출 방식을 `GET`에서 `POST`로 변경하고, 요청 본문 형식을 서버(`search_term`)에 맞춰 수정해 줘.

**4단계: 최종 검증 및 완료 (Verification)**

*   모든 코드 수정이 완료되면, 프로젝트 전체에 대해 다음 3가지 검증 절차를 순서대로 실행해 줘.
    1.  `npm run type-check`
    2.  `npm run lint --fix`
    3.  `npm run build`
*   위 과정에서 단 하나의 오류도 발생하지 않을 때까지 코드를 반복해서 수정하고, 모든 검증을 통과하면 작업을 최종 완료해 줘.

**# 제약 조건 (Constraints)**

*   반드시 **"🚨 긴급 (즉시 수정 필요)"** 항목 6가지를 모두 해결해야 해.
*   수정 사항은 반드시 `@tdd.md`의 가이드라인을 따라야 해.
*   임의로 파일 구조를 변경하거나 새로운 라이브러리를 추가해서는 안 돼.