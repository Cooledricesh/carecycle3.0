-- LAI í™˜ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ìŠ¤í¬ë¦½íŠ¸
-- ìƒì„±ì¼: 2025-09-02
-- ëŒ€ìƒ: 57ëª… LAI í™˜ì (ìµœìˆ˜í˜„ ì œì™¸ - ì´ë¯¸ ì¡´ì¬)
-- 
-- ì£¼ì˜ì‚¬í•­:
-- 1. í™˜ìë²ˆí˜¸(patient_number)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤ì¹­
-- 2. items.default_interval_weeksë¥¼ schedules.interval_weeksì— ë§¤í•‘
-- 3. LAI ìš©ëŸ‰ì„ schedules.notesì— ì €ì¥
-- 4. íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì›ìì„± ë³´ì¥

BEGIN;

-- ==========================================
-- STEP 1: ì„ì‹œ í…Œì´ë¸” ìƒì„± ë° ë°ì´í„° ì¤€ë¹„
-- ==========================================

CREATE TEMP TABLE temp_lai_migration (
    patient_number TEXT,
    patient_name TEXT,
    lai_drug TEXT,
    lai_dose TEXT,
    next_date TEXT
);

-- CSV ë°ì´í„° ì‚½ì… (57ëª…)
INSERT INTO temp_lai_migration (patient_number, patient_name, lai_drug, lai_dose, next_date) VALUES
('2101780', 'ê¹€íƒœí¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '700', '2025. 12. 9'),
('2129822', 'ë‚¨ëŒ€ì‹', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 19'),
('2061138', 'ì‹œì§€ì•ˆ', 'ì•„ë¹Œë¦¬íŒŒì´ ë©”ì¸í…Œë‚˜', '400', '2025. 8. 11'),
('2137404', 'ì „ì€í˜œ', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 17'),
('2124334', 'ì „í˜œì‹¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 11'),
('105561', 'ì •í•˜ì˜', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 10. 29'),
('102706', 'ìµœìš©ì„', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 17'),
('2071360', 'ê¹€ë™í˜„', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 10. 22'),
('2118539', 'ê¹€íƒœìš°', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 1. 7'),
('2135331', 'ë°°ì„ì¤€', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 9. 2'),
('101338', 'ì´ë™êµ¬', 'ì•„ë¹Œë¦¬íŒŒì´ ë©”ì¸í…Œë‚˜', '400', '2025. 9. 4'),
('2030954', 'ì´ìƒì¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 2'),
('2013223', 'ì„ëª…ìˆ™', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 25'),
('2003170', 'ìµœì€ì§€', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 12. 22'),
('974373', 'ì´ë™í¬', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 10. 22'),
('2022320', 'ì´ìŠ¹í¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 5'),
('2210311', 'ì •ì¤€í˜', 'ì•„ë¹Œë¦¬íŒŒì´ ë©”ì¸í…Œë‚˜', '400', '2025. 9. 11'),
('2051121', 'ì œì¢…ê·œ', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 9. 9'),
('995326', 'ê¹€ë¬´ì• ', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 9. 4'),
('2006350', 'ë°±ì§„ì£¼', 'ì¸ë² ê°€ ì„œìŠ¤í‹°ë‚˜', '150', '2025. 9. 22'),
('2233167', 'ì´ìƒìœ¤', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 12. 29'),
('2200901', 'ì´ì—°ì˜¥', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 12. 11'),
('2127540', 'ì´ì¸ìˆ™', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 10. 28'),
('2118912', 'ìµœì˜ì¼', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 14'),
('2032607', 'ê¹€ì •í¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 12. 25'),
('2221205', 'ë°•êµ¬í›ˆ', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '700', '2025. 9. 9'),
('2101913', 'ì´ì •ì›', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 2. 5'),
('2060314', 'ìµœë•ë¦¼', 'ì¸ë² ê°€ ì„œìŠ¤í‹°ë‚˜', '100', '2025. 9. 18'),
('103524', 'êµ¬ì˜ìˆ™', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 30'),
('2127434', 'ë‚¨ì¢…ìš°', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 22'),
('2120494', 'ì„œì •ì¸', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 11. 12'),
('2051050', 'ì†í™ê´€', 'ì¸ë² ê°€ ì„œìŠ¤í‹°ë‚˜', '100', '2025. 9. 24'),
('2030963', 'ì‹ ì£¼ì˜', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 17'),
('2114545', 'ì„í˜„ì •', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '700', '2025. 11. 19'),
('2082554', 'ìµœì§€í›ˆ', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 10. 7'),
('102470', 'ì„ë¯¸ìˆœ', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 9. 16'),
('102226', 'ìš°ì°½í˜•', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 9. 5'),
('101634', 'ìœ„ì„ í¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 1. 21'),
('2005716', 'ì „í¬ì§„', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 10. 16'),
('102496', 'ìµœì˜í™˜', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 10. 14'),
-- ìµœìˆ˜í˜„ ì œì™¸ (ì´ë¯¸ ì¡´ì¬: 2117226)
('105174', 'ì´ì„ í˜¸', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 10. 17'),
('2136863', 'ì´ì •ì² ', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '263', '2025. 11. 11'),
('105165', 'ìµœì •ì• ', 'ì•„ë¹Œë¦¬íŒŒì´ ì•„ì‹¬íˆ¬íŒŒì´', '960', '2025. 10. 23'),
('101273', 'ìµœíƒœìˆœ', 'ì•„ë¹Œë¦¬íŒŒì´ ë©”ì¸í…Œë‚˜', '300', '2025. 9. 4'),
('2121156', 'í•œëª…ìˆ˜', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 9. 22'),
('2212693', 'í•œìˆ˜ì', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '263', '2025. 9. 24'),
('2051152', 'ê¹€ê´‘ë¶„', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 10. 2'),
('104663', 'ë°•ì°¬ë™', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 1. 1'),
('2246150', 'ë°•ì„±ì¤€', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 1. 6'),
('2020719', 'ì‹ ì€ê²½', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 1. 6'),
('2247000', 'ê¹€ì˜ìš±', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 17'),
('2061794', 'ìµœì€ê·œ', 'ì¸ë² ê°€ ì„œìŠ¤í‹°ë‚˜', '150', '2025. 9. 17'),
('102694', 'ê¹€ë¬´ìˆ™', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 11. 7'),
('2247959', 'ì¥ì–¸ìˆ˜', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2026. 2. 5'),
('2005372', 'ì •ì¶˜í¬', 'ì¸ë² ê°€ í•˜í”¼ì—ë¼', '1000', '2025. 10. 27'),
('102998', 'ë¥˜ì„ ì', 'ì¸ë² ê°€ íŠ¸ë¦°ì', '525', '2025. 10. 29');

-- ==========================================
-- STEP 2: í™˜ì ë°ì´í„° UPSERT
-- ==========================================

-- ê¸°ì¡´ í™˜ì í™•ì¸ ë° ì—…ë°ì´íŠ¸, ì‹ ê·œ í™˜ì ì¶”ê°€
WITH migration_patients AS (
    SELECT DISTINCT 
        patient_number,
        patient_name
    FROM temp_lai_migration
)
INSERT INTO patients (
    patient_number,
    name,
    is_active,
    care_type,
    created_by,
    created_at
)
SELECT 
    mp.patient_number,
    mp.patient_name,
    true,
    'ì™¸ë˜',
    '61a97bc8-2662-48fa-8166-1f526e591a35'::uuid, -- ìƒ˜í”Œê³¼ ë™ì¼í•œ user_id
    NOW()
FROM migration_patients mp
ON CONFLICT (patient_number) 
DO UPDATE SET
    name = EXCLUDED.name,
    updated_at = NOW();

-- ==========================================
-- STEP 3: ìŠ¤ì¼€ì¤„ ë°ì´í„° ìƒì„±
-- ==========================================

-- ê¸°ì¡´ ìŠ¤ì¼€ì¤„ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
WITH existing_schedules AS (
    SELECT 
        p.patient_number,
        i.name as item_name
    FROM schedules s
    JOIN patients p ON s.patient_id = p.id
    JOIN items i ON s.item_id = i.id
    WHERE s.status = 'active'
)
-- ì‹ ê·œ ìŠ¤ì¼€ì¤„ ìƒì„±
INSERT INTO schedules (
    patient_id,
    item_id,
    start_date,
    next_due_date,
    status,
    interval_weeks,
    notes,
    requires_notification,
    notification_days_before,
    priority,
    created_by,
    assigned_nurse_id
)
SELECT 
    p.id as patient_id,
    i.id as item_id,
    TO_DATE(REPLACE(t.next_date, '. ', '-'), 'YYYY-MM-DD') as start_date,
    TO_DATE(REPLACE(t.next_date, '. ', '-'), 'YYYY-MM-DD') as next_due_date,
    'active' as status,
    i.default_interval_weeks as interval_weeks,
    t.lai_dose as notes,  -- ìš©ëŸ‰ ì •ë³´ë¥¼ notesì— ì €ì¥
    true as requires_notification,
    7 as notification_days_before,
    0 as priority,
    '61a97bc8-2662-48fa-8166-1f526e591a35'::uuid as created_by,
    '61a97bc8-2662-48fa-8166-1f526e591a35'::uuid as assigned_nurse_id
FROM temp_lai_migration t
JOIN patients p ON p.patient_number = t.patient_number
JOIN items i ON i.name = t.lai_drug AND i.category = 'injection'
LEFT JOIN existing_schedules es ON es.patient_number = t.patient_number AND es.item_name = t.lai_drug
WHERE es.patient_number IS NULL;  -- ì¤‘ë³µ ì œì™¸

-- ==========================================
-- STEP 4: ê²°ê³¼ ê²€ì¦
-- ==========================================

-- ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ í†µê³„
DO $$
DECLARE
    v_total_patients INTEGER;
    v_new_schedules INTEGER;
    v_skipped_schedules INTEGER;
BEGIN
    -- ì²˜ë¦¬ëœ í™˜ì ìˆ˜
    SELECT COUNT(DISTINCT patient_number) INTO v_total_patients
    FROM temp_lai_migration;
    
    -- ìƒì„±ëœ ìŠ¤ì¼€ì¤„ ìˆ˜
    SELECT COUNT(*) INTO v_new_schedules
    FROM schedules
    WHERE created_at >= NOW() - INTERVAL '1 minute';
    
    -- ì¤‘ë³µìœ¼ë¡œ ìŠ¤í‚µëœ ìŠ¤ì¼€ì¤„ ìˆ˜
    v_skipped_schedules := v_total_patients - v_new_schedules;
    
    RAISE NOTICE '==========================================';
    RAISE NOTICE 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í†µê³„';
    RAISE NOTICE '==========================================';
    RAISE NOTICE 'ì´ ì²˜ë¦¬ í™˜ì ìˆ˜: %', v_total_patients;
    RAISE NOTICE 'ì‹ ê·œ ìƒì„± ìŠ¤ì¼€ì¤„: %', v_new_schedules;
    RAISE NOTICE 'ì¤‘ë³µ ìŠ¤í‚µ ìŠ¤ì¼€ì¤„: %', v_skipped_schedules;
    RAISE NOTICE '==========================================';
END $$;

-- ì•½ë¬¼ë³„ ìŠ¤ì¼€ì¤„ ë¶„í¬ í™•ì¸
SELECT 
    i.name as "LAI ì•½ë¬¼",
    COUNT(*) as "ìŠ¤ì¼€ì¤„ ìˆ˜",
    STRING_AGG(DISTINCT s.notes, ', ') as "ìš©ëŸ‰ ì¢…ë¥˜"
FROM schedules s
JOIN items i ON s.item_id = i.id
WHERE s.status = 'active'
  AND i.category = 'injection'
GROUP BY i.name
ORDER BY COUNT(*) DESC;

-- ê¸´ê¸‰ë„ë³„ ìŠ¤ì¼€ì¤„ í™•ì¸ (9ì›” íˆ¬ì—¬ ì˜ˆì •)
SELECT 
    p.patient_number as "í™˜ìë²ˆí˜¸",
    p.name as "í™˜ìëª…",
    i.name as "LAI ì•½ë¬¼",
    s.notes as "ìš©ëŸ‰",
    s.next_due_date as "ë‹¤ìŒ íˆ¬ì—¬ì¼",
    CASE 
        WHEN s.next_due_date <= '2025-09-30' THEN 'ğŸ”´ ê¸´ê¸‰'
        WHEN s.next_due_date <= '2025-10-31' THEN 'ğŸŸ¡ ì£¼ì˜'
        ELSE 'ğŸŸ¢ ì—¬ìœ '
    END as "ìš°ì„ ìˆœìœ„"
FROM schedules s
JOIN patients p ON s.patient_id = p.id
JOIN items i ON s.item_id = i.id
WHERE s.status = 'active'
  AND i.category = 'injection'
  AND s.next_due_date >= CURRENT_DATE
ORDER BY s.next_due_date
LIMIT 20;

-- íŠ¸ëœì­ì…˜ ì»¤ë°‹
COMMIT;

-- ==========================================
-- ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš° ì•„ë˜ ëª…ë ¹ ì‹¤í–‰
-- ROLLBACK;
-- ==========================================